---
# get-kubeconfig.yml
- name: K3s Kubeconfig lokal bereitstellen
  hosts: manager
  become: true

  vars:
    # Identifiziert den primären Master
    primary_master: >-
      {{ groups['manager'] | map('extract', hostvars)
         | selectattr('k3s_control_node', 'defined')
         | selectattr('k3s_control_node', 'equalto', true)
         | map(attribute='inventory_hostname') | first }}

    local_config_path: "../k3s_pCLoud-kubeconfig.yaml"
    master_ip: "{{ hostvars[primary_master]['ansible_host'] }}"


  tasks:
    - name: Kubeconfig vom Master einlesen
      ansible.builtin.slurp:
        src: /etc/rancher/k3s/k3s.yaml
      register: kubeconfig_b64
      when: inventory_hostname == primary_master

    - name: Lokales Verzeichnis für Kubeconfig sicherstellen
      ansible.builtin.file:
        path: "{{ local_config_path | dirname }}"
        state: directory
        mode: '0755'
      delegate_to: localhost
      become: false
      when: inventory_hostname == primary_master
      run_once: true

    - name: Existierende Kubeconfig sichern
      ansible.builtin.copy:
        src: "{{ local_config_path }}"
        dest: "{{ local_config_path }}.backup-{{ ansible_date_time.epoch }}"
        mode: '0600'
      delegate_to: localhost
      become: false
      when:
        - inventory_hostname == primary_master
        - local_config_path is exists
      failed_when: false

    - name: Kubeconfig lokal speichern und anpassen
      ansible.builtin.copy:
        content: >-
          {{ hostvars[primary_master]['kubeconfig_b64'].content
             | b64decode | replace('127.0.0.1', master_ip) }}
        dest: "{{ local_config_path }}"
        mode: '0600'
      delegate_to: localhost
      become: false
      when: inventory_hostname == primary_master

    - name: Lokale Konnektivität prüfen
      ansible.builtin.command:
        cmd: "kubectl --kubeconfig {{ local_config_path }} get nodes -o wide"
      delegate_to: localhost
      become: false
      register: kubectl_check
      changed_when: false
      when:
        - inventory_hostname == primary_master
        - hostvars[primary_master]['kubeconfig_b64'] is defined

    - name: Cluster-Knoten anzeigen
      ansible.builtin.debug:
        msg: "{{ kubectl_check.stdout_lines }}"
      when:
        - inventory_hostname == primary_master
        - kubectl_check.stdout_lines is defined

    - name: Erwartete Knotenanzahl prüfen
      ansible.builtin.assert:
        that:
          - kubectl_check.stdout_lines | select('search', 'Ready') | list | length >= (groups['manager'] | length + groups['worker'] | length)
        fail_msg: "Nicht alle erwarteten Knoten sind im Cluster vorhanden oder bereit"
        success_msg: "Alle {{ groups['manager'] | length + groups['worker'] | length }} erwarteten Knoten sind im Cluster"
      when:
        - inventory_hostname == primary_master
        - kubectl_check.stdout is defined

